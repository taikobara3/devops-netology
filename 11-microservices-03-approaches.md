# Домашнее задание к занятию «Микросервисы: подходы»

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

## Задача 1: Обеспечить разработку

Предложите решение для обеспечения процесса разработки: хранение исходного кода, непрерывная интеграция и непрерывная
поставка.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их
взаимодействия.

Решение должно соответствовать следующим требованиям:

- облачная система;
- система контроля версий Git;
- репозиторий на каждый сервис;
- запуск сборки по событию из системы контроля версий;
- запуск сборки по кнопке с указанием параметров;
- возможность привязать настройки к каждой сборке;
- возможность создания шаблонов для различных конфигураций сборок;
- возможность безопасного хранения секретных данных (пароли, ключи доступа);
- несколько конфигураций для сборки из одного репозитория;
- кастомные шаги при сборке;
- собственные докер-образы для сборки проектов;
- возможность развернуть агентов сборки на собственных серверах;
- возможность параллельного запуска нескольких сборок;
- возможность параллельного запуска тестов.

Обоснуйте свой выбор.

Исходя из первых двух требований я бы остановился на двух основных облачных системах контроля версий Git - Gitlab и
Github

Для реализации требований, которые недостаточно удовлетворяются этими облачными системами контроля версий я бы дополнил
их системами CI/CD, такими как Jenkins или TeamCity
Эти системы позволят полноценно реализовать такие требование как, например, запуск сборки по кнопке с указанием
параметров

Для полноценной работы с репозиториями я бы также добавил такое решение, как Sonatype Nexus. Это позволит более
полноценно реализовать хранение артефактов, по сравнению со встроенным базовым функционалом CI/CD

Также, для обеспечения требования по безопасному хранению данных я бы предложил использовать Hashicorp Vault. Как более
простую, но более трудозатратную в процессе эксплуатации системы альтернативу этому решению можно хранить секретные
данные в системе СI/CD или вручную перемещать их на сервера из централизованного хранилища.

Таким образом, я бы предложил решение, состоящие из 4 компонентов

1. Gitlab - для хранения исходного кода и данных для инфраструктуры как кода, и конфигурации как кода
2. Jenkins - тестирование, сборка, CI/CD. Автоматический запуск сборки при изменениях в коде, ручной запуск сборок,
   выкладка стабильных релизов на рабочие системы
3. Sonatype Nexus - репозиторий артефактов
4. Hashicorp Vault - хранилище секретных данных

Первые два компонента для выполнения требований, поставленных в задаче являются абсолютно обязательныи (но их можно
заменить на указанные выше аналоги).
Последние два компонента не обязательны, но их использование может сделать решение более гибким и удобным

## Задача 2: Логи

Предложите решение для обеспечения сбора и анализа логов сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их
взаимодействия.

Решение должно соответствовать следующим требованиям:

- сбор логов в центральное хранилище со всех хостов, обслуживающих систему;
- минимальные требования к приложениям, сбор логов из stdout;
- гарантированная доставка логов до центрального хранилища;
- обеспечение поиска и фильтрации по записям логов;
- обеспечение пользовательского интерфейса с возможностью предоставления доступа разработчикам для поиска по записям
  логов;
- возможность дать ссылку на сохранённый поиск по записям логов.

Обоснуйте свой выбор.

Для сбора и анализа логов в микросервисной архитектуре я бы рекомендовал искользовать стек ELK:
Elastic beats или Filebeat для отправки логов
Logstash для препроцессинга логов, парсинга данных
Elasticsearch для хранения
Kibana в качестве пользовательского интерфейса

В качестве альтернативы можно рассмотреть решение на основе стека PLG (Promati, Loki, Grafana).
PLG, в целом обладает несколько лучшей масштабируемостью, эффективностью, несколько лучшей интегрируемостью с Kubernetes, но отстает от ELK по возможностям языка запросов.

Для сбора логов также можно использовать систему Sentry. Собираемые с ее помощью логи можно также завести в ELK/PLG

Можно также упомянуть систему Logger, использующую в качестве хранилища отечественную разаработку Clickhouse

## Задача 3: Мониторинг

Предложите решение для обеспечения сбора и анализа состояния хостов и сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их
взаимодействия.

Решение должно соответствовать следующим требованиям:

- сбор метрик со всех хостов, обслуживающих систему;
- сбор метрик состояния ресурсов хостов: CPU, RAM, HDD, Network;
- сбор метрик потребляемых ресурсов для каждого сервиса: CPU, RAM, HDD, Network;
- сбор метрик, специфичных для каждого сервиса;
- пользовательский интерфейс с возможностью делать запросы и агрегировать информацию;
- пользовательский интерфейс с возможностью настраивать различные панели для отслеживания состояния системы.

Обоснуйте свой выбор.

На мой взгляд сейчас для мониторинга можно делать выбор из двух основных решений - Zabbix и решений, построенных на Prometeus+Grafana

Zabbix привлекателен как единое монолитное и более универсальное решение, но проигрывает конкуренту в производительности и масштабируемости

Поскольку в задаче объявлены требования по сбору метрик - более эффективным решением будет Prometeus+Grafana - система изначально заточенная на сбор метрик.
Я предложил бы следующее решение:

Node_exporter для сбора метрик с микросервисов. Для более гибкого решения можно интегрировать Prometheus client libraries в код микросервисов
Prometheus - сбор метрик и сохранение их в БД временных рядов
Alertmanager - обработка уведомлений от Prometheus и рассылка (не требуется для выполнения требований задачи)
VictoriaMetrics - получение метрик из Prometheus, оптимизация долговременного хранения, высокопроизводительные запросы
Grafana - визуализация, пользовательсткий интерфейс